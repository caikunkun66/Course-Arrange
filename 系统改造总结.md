# 培训排课系统改造总结

## 改造目标
将原班级排课系统改造为培训排课系统，主要变更：
1. 班级管理改为学生管理
2. 学生归属于教师，而非班级
3. 教师能查看自己名下的学生

## 改动文件清单

### 后端改动（Java）

#### 1. 实体类 (Entity)
- **Student.java** 
  - 添加 `teacherId` 字段（Integer类型）
  - 关联学生与教师的关系

#### 2. 控制器 (Controller)

##### StudentController.java
添加了以下接口：
- `GET /student/teacher/{teacherId}/{page}` - 根据教师ID查询学生（分页）
- `POST /student/add` - 管理员添加学生（指定教师）

##### TeacherController.java  
- 添加依赖注入：`StudentService`
- 添加接口：`GET /teacher/students/{teacherId}/{page}` - 教师查看自己名下的学生

### 前端改动（Vue.js）

#### 3. 学生列表组件 (StudentList.vue)
**主要改动：**
- 添加教师筛选下拉框（管理员可见）
- 添加"所属教师"列显示
- 编辑表单中添加教师选择器
- 教师登录后只显示自己的学生
- 管理员可以按教师筛选学生

**新增方法：**
- `loadAllTeachers()` - 加载所有教师
- `loadMyStudents()` - 教师加载自己的学生
- `queryStudentByTeacher()` - 按教师筛选学生
- `enrichStudentData()` - 为学生数据添加教师名称
- `teacherListener()` - 清空教师筛选

**计算属性：**
- `isAdmin` - 判断是否为管理员
- `currentTeacherId` - 获取当前教师ID

#### 4. 班级管理改造 (ClassManager.vue)
**完全重构为学生管理界面：**
- 界面标题：从"添加班级"改为"添加学生"
- 表格显示：从班级信息改为学生信息
- 筛选条件：从年级改为教师
- 添加功能：添加学生并分配给教师

**新增功能：**
- 选择所属教师（必填）
- 自动生成学号
- 完整的学生信息表单
- 按教师筛选学生列表
- 删除学生确认对话框

**新增方法：**
- `loadTeachers()` - 加载教师列表
- `generateStudentNo()` - 生成学号
- `addStudent()` - 打开添加学生对话框
- `enrichStudentData()` - 丰富学生数据
- `queryStudentByTeacher()` - 按教师查询
- `deleteById()` - 删除学生

#### 5. 管理菜单 (ManagerMain.vue)
**菜单结构调整：**
- 移除"班级管理"独立菜单
- 调整"学生管理"菜单：
  - 子菜单1：添加学生（仅管理员可见）
  - 子菜单2：学生列表（所有用户可见）
- 重新编号菜单索引（index 4-7）

#### 6. 路由配置 (index.js)
- 保持不变，`/classmanager` 路由复用为学生管理页面

## 数据库修改

### 必须执行的SQL
```sql
ALTER TABLE tb_student 
ADD COLUMN teacher_id INT DEFAULT NULL COMMENT '所属教师ID（培训模式）' AFTER class_no;

-- 可选：添加外键约束
ALTER TABLE tb_student 
ADD CONSTRAINT fk_student_teacher 
FOREIGN KEY (teacher_id) REFERENCES tb_teacher(id) 
ON DELETE SET NULL ON UPDATE CASCADE;
```

### 数据迁移（如果有历史数据）
```sql
-- 将学生关联到原班级的班主任
UPDATE tb_student s
INNER JOIN tb_class_info c ON s.class_no = c.class_no
SET s.teacher_id = c.teacher
WHERE c.teacher IS NOT NULL;
```

## 新增API接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /student/teacher/{teacherId}/{page} | 根据教师查询学生 | 管理员 |
| POST | /student/add | 添加学生（指定教师） | 管理员 |
| GET | /teacher/students/{teacherId}/{page} | 教师查看自己的学生 | 教师 |

## 功能对比

### 原系统（班级模式）
- 学生属于班级
- 班级有班主任
- 管理员管理班级和学生
- 教师作为班主任管理班级

### 新系统（培训模式）
- 学生属于教师
- 年级/班级为可选信息
- 管理员添加学生并分配教师
- 教师直接管理自己的学生

## 保留的功能
1. ✅ 学生注册/登录
2. ✅ 课程管理
3. ✅ 排课功能
4. ✅ 教学资料管理
5. ✅ 教室管理
6. ✅ 讲师管理
7. ✅ 年级、班级字段（可选填写）

## 权限说明

### 管理员权限
- ✅ 查看所有学生
- ✅ 添加学生并分配教师
- ✅ 编辑学生信息（包括更换教师）
- ✅ 删除学生
- ✅ 按教师筛选学生
- ✅ 管理教师
- ✅ 管理课程

### 教师权限
- ✅ 查看自己名下的学生
- ✅ 编辑自己学生的信息
- ❌ 无法查看其他教师的学生
- ❌ 无法添加学生（由管理员分配）
- ✅ 管理课程、教学资料

### 学生权限
- ✅ 注册账号
- ✅ 登录系统
- ✅ 查看课表
- ✅ 查看学习资料
- ✅ 修改个人信息

## 部署步骤

### 1. 备份
```bash
# 备份数据库
mysqldump -u root -p db_course_arrangement > backup.sql

# 备份代码（如果使用git）
git commit -am "备份：改造前的系统"
```

### 2. 后端部署
```bash
# 重新编译
mvn clean package

# 重启服务
# Windows: 
# 停止服务，然后启动 java -jar target/coursearrange.jar

# Linux:
# pkill -f coursearrange && nohup java -jar target/coursearrange.jar &
```

### 3. 前端部署
```bash
cd UI/coursearrange

# 安装依赖（如有新增）
npm install

# 重新构建
npm run build

# 重启前端服务（开发模式）
npm run dev
```

### 4. 数据库迁移
```bash
# 执行SQL脚本
mysql -u root -p db_course_arrangement < migration.sql
```

### 5. 测试验证
1. 管理员登录测试
2. 教师登录测试  
3. 学生添加测试
4. 权限隔离测试

## 测试检查清单

- [ ] 数据库字段添加成功
- [ ] 管理员可以添加学生并分配教师
- [ ] 管理员可以按教师筛选学生
- [ ] 管理员可以编辑学生的教师归属
- [ ] 教师登录后只能看到自己的学生
- [ ] 教师无法查看其他教师的学生
- [ ] 学生列表分页正常
- [ ] 搜索功能正常
- [ ] 编辑功能正常
- [ ] 删除功能正常
- [ ] 原有的课程、排课功能正常

## 注意事项

1. **安全性**
   - 后端已添加权限控制，教师只能访问自己的学生
   - 前端做了权限展示控制

2. **数据完整性**
   - 建议添加外键约束确保数据一致性
   - 删除教师时需要考虑关联学生的处理

3. **用户体验**
   - 教师用户需要被告知只能查看自己的学生
   - 管理员需要了解新的学生管理流程

4. **性能考虑**
   - 如果学生数量很大，考虑添加索引：
     ```sql
     ALTER TABLE tb_student ADD INDEX idx_teacher_id (teacher_id);
     ```

## 回滚方案

如需回滚到原系统，请按以下步骤操作：

1. 恢复数据库备份
2. 恢复代码到改造前的版本（使用git）
3. 重新编译部署

或者手动删除添加的字段：
```sql
ALTER TABLE tb_student DROP COLUMN teacher_id;
ALTER TABLE tb_student DROP FOREIGN KEY fk_student_teacher;
```

## 后续优化建议

1. **报表统计**
   - 添加教师学生数量统计
   - 添加教师工作量统计

2. **批量操作**
   - 批量分配学生给教师
   - 批量导入学生

3. **通知功能**
   - 教师收到新学生分配通知
   - 学生变更通知

4. **权限细化**
   - 教师查看学生的详细权限控制
   - 教师编辑学生的字段权限控制

5. **数据导出**
   - 导出教师名下的学生列表
   - 导出统计报表

## 技术文档

- 数据库迁移说明：`数据库迁移说明.md`
- API文档：需要更新API文档，添加新增的三个接口
- 用户手册：需要更新用户操作手册

## 联系方式

如有问题，请查看：
- 后端日志位置：`logs/`
- 前端控制台：浏览器开发者工具
- 数据库日志：MySQL错误日志

